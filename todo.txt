Error: Cannot start taker charged timer for offer 0218d39b-ca42-47b7-8a3e-2aca38bd2696 without blikReceivedAt timestamp or not in state takerCharged, status is OfferStatus.expiredSentBlik blikReceivedAt: 2025-12-05 13:32:37.240359


=== CRITICAL BUGS
- !!!! calculate fee sum to include routing fees - needs pre-route estimation before creating invoice
- !!!! terms of use should have coordinator name after to be clear that it's not bitblik app terms of use but coordinator's
- !!! getSuccessfulOffersWithStats mixes avg BLIK received while UI shows taken after
- !!! Brandkit ala https://github.com/getAlby/media  & https://getalby.com/brandkit (from figma)
- !!!! should not be able to cancel offer if not sure it didn't got created (paid invoice NWC) in coordinator, otherwise client looses access to it.
- !!!! cannot get info from coordinator on saunter's ios
- !!!! loses the created offer after payment???
- !! settle maker invoice after 1 hour even if not confirmed so that we can resolve conflict having the sats
- !! refresh (pull-down) offers list does not work
- !!
     LNURL Error: Step 2 request failed (500) for : {"reason":"Invoice error: timeout","status":"ERROR"}
    test-coordinator  | Could not get an invoice for net amount 30 sats for LN address
    should better show UI error of invalid LNURL instead of timeout
- ! pay in wallet on browser when no webln available should launch lightning:// with choice of wallet apps
- ! in progress offers should be listed in offer list with that in progress (reserved), timer
- /create on web doesn't see the status update - websocket/relay disconnect/reconnect WTF?


=== FEATURES
-!!! premium % above market price for maker
-!!! start the offer with higher taker fees, and if some seconds it's still not reserved decrease the taker fees and send new notification to groups

-!!! NWC wallet integration
    - ndk.wallets (NWC) from leo's branch
    - use ndk.accounts instead of single signer (multiple nekos)
    - maybe ndk_flutter luc's widgets?

-!!! info + checkbox risk of refund BLIK acceptance
    - choice of type of payment
        - physical good in shop
        - atm cash out
        - online service/product

-!! how to communicate with maker/taker on dispute?
    - send nostr DM to coordinator (which NIP?)
    - sign message tool in neko

-!! ??? in invalidBlik status maker has no way out, so taker can DoS attack maker by sending invalid blik codes
    - max 3 blik codes for same taker pubKey?
    - timeout for taker to decide on what to do
    - bond from taker to start reservation?
        - fidelity bond for taker

-! list of current/finished offers for current Neko in menu
-! reputation mode (maybe using nostr profiles and WoT?)
-! notifications moar!
    - by nostr
    - by foreground service
    - webpushs?

- dark theme

=== TASKS
-!!! review terms of use
-!! psql backup cron

=== IMPROVEMENTS
-!!! missing clock progress in make confirm blik (2min)
    - and after inform of 60m it will automatically be settled in taker's favor
-!!! whitelist coordinators:
    - from bitblik followed list
    - list of default accepted coordinator's npubs in client, overridable by env vars for test.bitblik.app
-!! coordinator metadata kind-0
    - name
    - avatar picture
    - relays (nip-65)
        - relays for coordinator fetched from nip-65
            - if non existent and configured in .env broadcast nip-65 event with relay list


- timer when waiting for taker is calculated from created_at offer which is not at the time the offer was saved in DB but when created in client UI
    - should be fixed now that nip69 created_at is not used anymore, to confirm!
-?? should confirm offer data from coordinator and not only rely on nostr KIND_OFFER event, for offer list and details

- sound effects when status changes
- local notifications when status changes

------------------------------------------------------------------
- after blikReceived the offer details should not show the reservation time countdown since it's wrong amount of time
    - maybe update offer status to in-progress or something !??!?!?!
- offer details screen should subscribe to offer status change and update status in UI
  - and show timers (reserved time left, blik code validity time left)
  - this is needed when it's not a get_my_active_offer, since status updates it's only for active per key
- coordinator discovery on bootstrap many relays (purplepag.es)

- retry to subscribe in nostr service for KIND_COORDINATOR_REQUEST (client requests) onError
- if maker confirms during conflict (made mistake) the taker conflict screen should listen to such status and show process paying screen
- remove circular dependency between coordinator/nostr services !!
- fix the tests for nostr service not available
- public stats / coordinator info should not require client pubkey (rpc signing request)


- discount codes (on fees) for certain keys at the coordinator
- rate coordinators on nostr (find which NIP for ratings)


- after opening/closing numeric keyboard the bottom bar stays big height - but only when CANCEL/CLOSE keyboard (graphene only?)
- while in /taker-conflict if maker confirms it should refresh and show taker success

- save the failed payment reason (could not get an invoice from lnurl/ no route /??) and show it on takerFailedPayment screen

- extract common code between coordinator & client (offer model)
- coordinator /admin/* for admin actions on allowed pubkeys
- stats like https://plebqr.com/ for coordinator
- S. suggestions
    - more info about exchange rate sources (average)
    - wyslij blik nie na czerwone?

=== ???
- handle reservation / cancel near offer expiration time to avoid reseting to funded
    and fucking up the state diagram dependencies, specially when in conflict/dispute states.
- offers from custom coordinators should still show coordinator info on offer details screen
